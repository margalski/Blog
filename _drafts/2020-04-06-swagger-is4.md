---
layout: post
title: Integrate swagger with Identity Server 4
date: '2020-04-06 08:00:00 +0100'
categories:
  - development
tags:
  - swagger
  - net core
  - Identity Server 4
published: true
---
## ðŸ’¡ When you are creating one of APIs in microservices architecture best way to create clear documentation with a frieldy GUI to directly test them is Swagger. Running Swagger with API is quite easy and well documented, but when API is protecting by OAuth it's tricki to integrate it. In this post I will show you how to runn sample .NET Core 3.1 API with Swagger (Swashbuckle for .NET) and Swagger Authroziation via Identity Server 4.
###

### 1. Add Swagger to ASP NET Core project 
First we need to install nuget package via Package Manager Console
```bat 
Install-Package Swashbuckle.AspNetCore
``` 
After that go to **Startup.cs** file and change ***ConfigureServices*** method to look like this bellow:
```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();
    services.AddSwaggerGen(c =>
    {
        c.SwaggerDoc("v1", new OpenApiInfo { Title = "My API", Version = "v1" });
    });
}
```
and change ***Configure*** method like this:
```csharp
public void Configure(IApplicationBuilder app)
{ 
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "My API V1");
    });
    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllers();
    });
    app.UseRouting();
}
```
##### And basicly that is it to configure Swagger with minumum options. 
#
To see the results of Swagger work we need to add Controller and Model: 
```csharp
[Route("v1/[controller]")]
[ApiController]
public class DemoController : ControllerBase
{ 
    [HttpGet]
    public IActionResult GetDemoValues() 
        => Ok(new string[] { "value1", "value2" });
 
    [HttpPost]
    [Route("post")]
    public IActionResult PostDemoModel(DemoModel model) 
        => Ok(model);
    }
``` 
```csharp
public class DemoModel
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; }
}
```
Before we start application we can go to **launchSettings.json** file and change ***launchUrl*** to ***swagger***
```
"launchUrl": "swagger",
```
##### Now we can run our demo API and see the results

![swagger-ui-demo-example]({{site.baseurl}}/_posts/swagger-demo.PNG)

##
### 2. Protect our API using IdentityServer
First, we need to install IdentityServer4 library:
```console
Install-Package IdentityServer4.AccessTokenValidation
```
Than we need to add new private method in **Startup.cs** for register authentication server
```csharp
protected void ConfigureAuth(IServiceCollection services)
{
    services.AddAuthentication(IdentityServerAuthenticationDefaults.AuthenticationScheme)
        .AddIdentityServerAuthentication(options =>
        {
            options.Authority = "http://localhost:44333";  // identity server endpoint
            options.ApiName = "demo-test-api-scope";
            options.RequireHttpsMetadata = false; // this should be true on production
        });
}
```
and call this ***ConfigureAuth*** private method in ***ConfigureServices*** method
```csharp
 public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();
    ConfigureAuth(services);
    services.AddSwaggerGen(c =>
    {
        c.SwaggerDoc("v1", new OpenApiInfo { Title = "My API", Version = "v1" });
    });
}
```
also we need to change ***Configure*** method and add one more line with ***app.UseAuthentication();***
```csharp
public void Configure(IApplicationBuilder app)
{
    app.UseAuthentication();
...
```
##
When we have all those things in **Startup.cs** file setuped we just need to decided wchich Controllers or Actions will be authorization protected. We can also add an global authorization filter which means we are no needed to add that one-by-one on all our app's controllers and all the actions. I think that better approach is to by default have all action resctricted by authorization that remember at every new controller to add [Authorization] attribute.

So, to add gloabl aithorization filter we only need to add call of ***AddMvc*** inside of ***ConfigureServices*** method in **Startup.cs**
```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddMvc(options =>
    {
        options.Filters.Add(new AuthorizeFilter(new AuthorizationPolicyBuilder()
            .RequireAuthenticatedUser()
            .AddAuthenticationSchemes(IdentityServerAuthenticationDefaults.AuthenticationScheme)
            .Build()));
    });
...
```

#### Now when we compile and run our API and try to call actions from Swagger we'll receive 401 status code
![Swagger example 401 call]({{site.baseurl}}/_drafts/swagger-demo-401.PNG)

### 3. IdentityServer configuration
I assumed that you have setuped IdentityServer project. Then we need to add a new client configuration for Swagger UI. Here is how it should look like:

```csharp
new Client
{
    ClientId = "mvc-test-api-swagger-app",
    ClientName = "Mvc test API Swagger APP",
    RequireClientSecret = false,
    RequireConsent = false,
    AllowAccessTokensViaBrowser = true,
    AllowedGrantTypes = GrantTypes.ImplicitAndClientCredentials,
    RedirectUris =
    {
        "http://localhost:44304/swagger/oauth2-redirect.html",
        "https://localhost:44304/swagger/oauth2-redirect.html"
    },
    PostLogoutRedirectUris =
    {
        "http://localhost:44304/swagger/index.html",
        "https://localhost:44304/swagger/index.html"
    },
    AllowedScopes =
    {
        "demo-test-api-scope"
    },
}
```

### 4. Dealing with Swagger UI authentitaction via Identity Server
At this point we need to modify previous setup of Swagger in **Startup.cs**. But first, we need to add more libraries
```console
Install-Package Swashbuckle.AspNetCore
Install-Package Swashbuckle.AspNetCore.Swagger
```
Then, go to **Startup.cs** and change call method ***AddSwaggerGen*** in ***ConfigureServices*** method as follows:
```csharp
...
services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo { Title = "My API", Version = "v1" });
    c.AddSecurityDefinition(SecuritySchemeType.OAuth2.ToString(), new OpenApiSecurityScheme
    {
        Type = SecuritySchemeType.OAuth2,
        Flows = new OpenApiOAuthFlows
        {
            Implicit = new OpenApiOAuthFlow
            {
                AuthorizationUrl = new Uri("http://localhost:44333/connect/authorize"),
                Scopes = new Dictionary<string, string>() 
                { 
                    { 
                        "demo-test-api-scope", "Demo API Swagger Auth Example" 
                    } 
                },
            }
        }
    });
});

```

Swagger UI is running in the user browser so we need to use the implicit flow. 
Next thing that we need to do is setup ConfigureOAuth2 in Swagger UI configuration. All we have to do is to add one line in UseSwaggerUI call method in Startup.cs Configure
```csharp
public void Configure(IApplicationBuilder app)
{
    app.UseAuthentication();
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "My API V1");
        c.OAuthClientId("mvc-test-api-swagger-app"); // this is a ClientId from IdentityServer configuration
    });
...
```

Now we need to append OAuth2 requirements to actions that have Authorize attribute. So, create new class **AuthorizeCheckOperationFilter.cs** and past foloowing code
```csharp
public class AuthorizeCheckOperationFilter : IOperationFilter
{
    public void Apply(OpenApiOperation operation, OperationFilterContext context)
    {
        var requiredScopes = context.MethodInfo
            .GetCustomAttributes(true)
            .OfType<AuthorizeAttribute>()
            .Select(attr => attr.Policy)
            .Distinct();
            
        if (requiredScopes.Any())
        {
            operation.Responses.Add("401", new OpenApiResponse { Description = "Unauthorized" });
            operation.Responses.Add("403", new OpenApiResponse { Description = "Forbidden" });
            var oAuthScheme = new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = "oauth2" }
            };
            operation.Security = new List<OpenApiSecurityRequirement>
            {
                new OpenApiSecurityRequirement
                {
                    [ oAuthScheme ] = requiredScopes.ToList()
                }
            };
        }
    }
}
```
Last thing that we have to do is to register operation filter in AddSwaggerGen method in **Startup.cs**
```csharp
public void ConfigureServices(IServiceCollection services)
{
    ...

  services.AddSwaggerGen(c =>
  {
     ...

      c.OperationFilter<AuthorizeCheckOperationFilter>();

...
```

### Let's check how it works
Ok, now we can run our API, and go to /swagger/index.html, you will see an Authorize button at the top right. After you click it will open a modal popup.
It should look like this:
 